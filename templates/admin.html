<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Glopac Shipping Express | Admin Panel</title>
  <style>
    :root{
      --brand:#003366;
      --brand2:#002244;
      --bg:#f4f7fa;
      --card:#ffffff;
      --muted:#5a667a;
      --line:#e6eaf0;
      --good:#1f8f4e;
      --danger:#e74c3c;
      --warn:#b36b00;
    }
    *{box-sizing:border-box}
    body { font-family: Arial, sans-serif; margin:0; background:var(--bg); color:#0b1220; }

    .topbar{
      background:var(--brand2);
      color:#fff;
      padding:10px 18px;
      font-size:14px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
    }
    .topbar a{ color:#fff; font-weight:900; text-decoration:none; opacity:.95; margin-left:14px; }
    .topbar a:hover{opacity:1;text-decoration:underline;}

    header{background:var(--card);border-bottom:1px solid var(--line);}
    .header-inner{
      max-width:1200px;margin:0 auto;padding:14px 18px;
      display:flex;align-items:center;justify-content:space-between;gap:16px;
    }
    .brandbox{display:flex;align-items:center;gap:12px;}
    .brandbox img{height:44px;width:auto;display:block;}
    .brandbox .name{font-weight:900;color:var(--brand);letter-spacing:.2px;font-size:18px;line-height:1.1;}
    .brandbox .tag{font-size:12px;color:var(--muted);font-weight:700;margin-top:2px;}

    .wrap{max-width:1200px;margin:0 auto;padding:18px;}
    .grid{display:grid;grid-template-columns: 1.1fr .9fr; gap:14px; align-items:start;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow:0 8px 24px rgba(11,18,32,.06);
      margin-bottom:14px;
    }
    h2{margin:0 0 12px;color:var(--brand);}
    .muted{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.45;}

    label{display:block;margin:10px 0 5px;font-weight:800;color:#1b2a44;}
    input, textarea, select{
      width:100%;
      padding:10px;
      border:1px solid var(--line);
      border-radius:10px;
      outline:none;
      background:#fff;
      font-size:14px;
    }
    textarea{resize:vertical}
    .btn{
      padding:11px 14px;
      border:0;
      border-radius:10px;
      background:var(--brand);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      margin-top:10px;
    }
    .btn:hover{background:var(--brand2);}
    .btn-good{background:var(--good);}
    .btn-danger{background:var(--danger);}
    .btn-warn{background:var(--warn);}

    .list{list-style:none;padding:0;margin:0;}
    .item{
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      margin:10px 0;
    }
    .topline{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .tid{font-weight:900;}
    .small{font-size:12px;color:var(--muted);margin-top:6px;}
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--line);
      background:#f8fafc;
      color:var(--muted);
      margin-top:8px;
    }
    .pill-hold{background:#fff3cd;border-color:#ffe69c;color:#8a5a00;}
    .pill-paid{background:#eaf7ef;border-color:#cfead9;color:#1f8f4e;}
    .pill-pending{background:#eef3fb;border-color:#d7e3f7;color:var(--brand);}

    .inline-form{
      display:grid;
      grid-template-columns: 1.1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
      align-items:end;
    }
    .inline-form .full{grid-column: 1 / -1;}
    .inline-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    .hr{border-top:1px solid var(--line); margin:14px 0;}
    .two{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
      .inline-form{grid-template-columns:1fr;}
      .two{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div>Glopac Shipping Express Admin • Manage shipments, users & payments</div>
    <div>
      <a href="/">Home</a>
      <a href="/logout">Logout</a>
    </div>
  </div>

  <header>
    <div class="header-inner">
      <div class="brandbox">
        <img src="/static/img/glopacshippingexpress-logo.jpg" alt="Glopac Shipping Express Logo">
        <div>
          <div class="name">Glopac Shipping Express</div>
          <div class="tag">Admin Panel</div>
        </div>
      </div>
      <div class="small">
        Logged in as <b>{{ user.email }}</b>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">

      <!-- LEFT -->
      <div>

        <!-- Applications -->
        <div class="card">
          <h2>New Applications</h2>
          <p class="muted">Approve to create a user account and assign a plain password. Reject to decline.</p>

          {% if applications and applications|length > 0 %}
            <ul class="list">
              {% for a in applications %}
                <li class="item">
                  <div class="topline">
                    <div>
                      <div class="tid">{{ a.name }} — {{ a.email }}</div>
                      <div class="small"><b>Status:</b> {{ a.status }} • <b>Submitted:</b> {{ a.submitted_at }}</div>
                      {% if a.reason %}<div class="small"><b>Reason:</b> {{ a.reason }}</div>{% endif %}
                      {% if a.admin_note %}<div class="small"><b>Admin note:</b> {{ a.admin_note }}</div>{% endif %}
                    </div>
                    <div>
                      {% if a.status == "pending" %}
                        <span class="pill pill-pending">Pending</span>
                      {% elif a.status == "approved" %}
                        <span class="pill pill-paid">Approved</span>
                      {% else %}
                        <span class="pill pill-hold">Rejected</span>
                      {% endif %}
                    </div>
                  </div>

                  {% if a.status == "pending" %}
                    <div class="hr"></div>

                    <div class="two">
                      <form action="/admin/approve/{{ a.email }}" method="post">
                        <label>Assign Password (plain)</label>
                        <input type="text" name="password" placeholder="Set a password for this user" required>

                        <label>Admin note (optional)</label>
                        <input type="text" name="admin_note" placeholder="e.g. Approved - verified identity">

                        <button class="btn btn-good" type="submit">Approve & Create User</button>
                      </form>

                      <form action="/admin/reject/{{ a.email }}" method="post">
                        <label>Admin note (optional)</label>
                        <input type="text" name="admin_note" placeholder="Reason for rejection">

                        <button class="btn btn-danger" type="submit">Reject</button>
                      </form>
                    </div>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted">No applications yet.</p>
          {% endif %}
        </div>

        <!-- Create / Update shipment -->
        <div class="card">
          <h2>Add / Update Shipment</h2>
          <p class="muted">
            Create a shipment or update any fields. If status is <b>On Hold</b>, you can add fees.
          </p>

          <form action="/admin" method="post">
            <input type="hidden" name="form_type" value="shipment">

            <label>Tracking ID</label>
            <input type="text" name="tracking_id" required placeholder="e.g. BOE808080">

            <div class="two">
              <div>
                <label>Status</label>
                <input type="text" name="status" required placeholder="In Transit, On Hold, Delivered">
              </div>
              <div>
                <label>Owner Email</label>
                <input type="email" name="owner_email" placeholder="customer@email.com">
              </div>
            </div>

            <div class="two">
              <div>
                <label>Origin (address/city)</label>
                <input type="text" name="origin" placeholder="e.g. New York, USA">
              </div>
              <div>
                <label>Destination (address/city)</label>
                <input type="text" name="destination" placeholder="e.g. London, UK">
              </div>
            </div>

            <label>Package Details</label>
            <input type="text" name="package_details" placeholder="e.g. Electronics - 2kg">

            <div class="two">
              <div>
                <label>Expected Delivery Date</label>
                <input type="date" name="estimated_delivery">
                <div class="small">If you check the box below, date will show as “available when hold clears”.</div>
              </div>
              <div>
                <label>
                  <input type="checkbox" name="estimated_delivery_tbd_on_hold" style="width:auto;margin-right:8px;">
                  Date will be made available when hold clears
                </label>
              </div>
            </div>

            <div class="two">
              <div>
                <label>Customs/Taxes Fee Amount (optional)</label>
                <input type="number" step="0.01" name="fees_amount" placeholder="e.g. 45.50">
              </div>
              <div>
                <label>Fee Reason (optional)</label>
                <input type="text" name="fees_reason" placeholder="e.g. Customs and Taxes">
              </div>
            </div>

            <label>
              <input type="checkbox" name="fees_paid" style="width:auto;margin-right:8px;">
              Mark fees as paid (optional)
            </label>

            <label>Route (JSON array of points) — optional</label>
            <textarea name="route" rows="5"
              placeholder='[{"lat":40.7128,"lng":-74.0060,"label":"New York"}, {"lat":51.5074,"lng":-0.1278,"label":"London"}]'></textarea>

            <label>Current Location (JSON - optional)</label>
            <input type="text" name="current_location" placeholder='{"lat":48.8566,"lng":2.3522}'>

            <button class="btn" type="submit">Save Shipment</button>
          </form>
        </div>
      </div>

      <!-- RIGHT: Shipments -->
      <div>
        <div class="card">
          <h2>Existing Shipments</h2>
          <p class="muted">Admin can edit status & fees for any shipment (even Delivered).</p>

          {% if shipments %}
            <ul class="list">
              {% for ship in shipments %}
                <li class="item">
                  <div class="topline">
                    <div>
                      <div class="tid">{{ ship.tracking_id }} — {{ ship.status }}</div>
                      <div class="small"><b>Owner:</b> {{ ship.owner_email or "Unassigned" }}</div>
                      {% if ship.origin or ship.destination %}
                        <div class="small"><b>From:</b> {{ ship.origin or "-" }} • <b>To:</b> {{ ship.destination or "-" }}</div>
                      {% endif %}

                      {% if ship.estimated_delivery_tbd_on_hold %}
                        <div class="small"><b>Expected delivery:</b> Date will be made available when hold clears</div>
                      {% elif ship.estimated_delivery %}
                        <div class="small"><b>Expected delivery:</b> {{ ship.estimated_delivery }}</div>
                      {% endif %}

                      {% if ship.fees and not ship.fees.paid %}
                        {% if ship.fees.payment_submitted %}
                          <div class="pill pill-pending">Payment Submitted</div>
                        {% else %}
                          <div class="pill pill-hold">On Hold (Unpaid Fees)</div>
                        {% endif %}
                      {% elif ship.fees and ship.fees.paid %}
                        <div class="pill pill-paid">Fees Paid</div>
                      {% endif %}

                      <!-- ✅ UPDATED: Added Open Chat link -->
                      <div class="small" style="margin-top:8px; display:flex; gap:14px; flex-wrap:wrap;">
                        <a href="/track?tracking_id={{ ship.tracking_id }}">View tracking</a>
                        <a href="/admin/chat/{{ ship.tracking_id }}" style="font-weight:900;">Open chat</a>
                      </div>
                    </div>

                    <form action="/delete/{{ ship.tracking_id }}" method="post">
                      <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                  </div>

                  <!-- INLINE EDIT FORM -->
                  <form action="/admin/update/{{ ship.tracking_id }}" method="post">
                    <div class="inline-form">
                      <div>
                        <label>Status</label>
                        <select name="status" required>
                          {% set st = ship.status or "" %}
                          <option value="{{ st }}">{{ st if st else "Choose…" }}</option>

                          <option value="Label Created">Label Created</option>
                          <option value="Picked Up">Picked Up</option>
                          <option value="In Transit">In Transit</option>
                          <option value="Arrived at Destination Country">Arrived at Destination Country</option>

                          <!-- ✅ ADDED (as requested) -->
                          <option value="Clearance Update">Clearance Update</option>
                          <option value="Clearance Process Successful">Clearance Process Successful</option>
                          <option value="Awaiting Dispatch">Awaiting Dispatch</option>
                          <!-- ✅ END ADDED -->

                          <option value="Out for Delivery">Out for Delivery</option>
                          <option value="Delivered">Delivered</option>
                          <option value="Delayed">Delayed</option>
                          <option value="On Hold">On Hold</option>
                          <option value="Custom Status">Custom Status</option>
                        </select>
                        <div class="small">Choose “Custom Status” then type below.</div>
                      </div>

                      <div>
                        <label>Fees Amount</label>
                        <input type="number" step="0.01" name="fees_amount"
                               value="{{ ship.fees.amount if ship.fees and ship.fees.amount is not none else '' }}"
                               placeholder="e.g. 125.00">
                      </div>

                      <div>
                        <label>Fees Reason</label>
                        <input type="text" name="fees_reason"
                               value="{{ ship.fees.reason if ship.fees and ship.fees.reason else '' }}"
                               placeholder="e.g. Customs and Taxes">
                      </div>

                      <div class="full">
                        <label>Expected Delivery Date</label>
                        <input type="date" name="estimated_delivery" value="{{ ship.estimated_delivery or '' }}">
                        <label style="margin-top:10px;">
                          <input type="checkbox" name="estimated_delivery_tbd_on_hold" style="width:auto;margin-right:8px;"
                                 {% if ship.estimated_delivery_tbd_on_hold %}checked{% endif %}>
                          Date will be made available when hold clears
                        </label>
                      </div>

                      <div class="full">
                        <label>If “Custom Status”, type here</label>
                        <input type="text" name="custom_status" placeholder="e.g. Held at Sorting Facility">
                      </div>

                      <div class="full">
                        <label>
                          <input type="checkbox" name="clear_fees" value="1" style="width:auto; margin-right:8px;">
                          Clear fees (remove fees object)
                        </label>
                      </div>
                    </div>

                    <div class="inline-actions">
                      <button class="btn btn-good" type="submit">Save Changes</button>
                    </div>
                  </form>

                  {% if ship.fees and ship.fees.payment_submitted and not ship.fees.paid %}
                    <form action="/verify_payment/{{ ship.tracking_id }}" method="post" style="margin-top:8px;">
                      <button type="submit" class="btn btn-warn">Verify & Release</button>
                    </form>
                  {% endif %}

                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No shipments yet.</p>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</body>
</html>

